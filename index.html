<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spirit-Nav | Radar √âth√©rique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Polices 2026 : Editorial Serif + Tech Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif'],
                    },
                    colors: {
                        'spirit': {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6', // Teal
                            600: '#0d9488',
                            900: '#134e4a',
                            950: '#042f2e',
                        },
                        'void': '#020617', // Slate 950 extended
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 12s linear infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- GESTION DES COULEURS DYNAMIQUES (JOUR/NUIT) --- */
        :root {
            /* Couleurs Mode Jour (Light) */
            --bg-start: #f8fafc; /* Slate 50 */
            --bg-end: #e2e8f0;   /* Slate 200 */
            --orb-1: #99f6e4;    /* Teal 200 */
            --orb-2: #bfdbfe;    /* Blue 200 */
            --orb-3: #ddd6fe;    /* Violet 200 */
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: rgba(0, 0, 0, 0.05);
            --text-main: #0f172a;
            --text-muted: #64748b;
        }

        .dark {
            /* Couleurs Mode Nuit (Dark) */
            --bg-start: #111827; /* Gray 900 */
            --bg-end: #020617;   /* Slate 950 */
            --orb-1: #0f766e;    /* Teal 700 */
            --orb-2: #1e3a8a;    /* Blue 900 */
            --orb-3: #4c1d95;    /* Violet 900 */
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.05);
            --glass-shadow: rgba(0, 0, 0, 0.2);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            color: var(--text-main);
            overflow-x: hidden;
            transition: color 0.5s ease;
        }

        /* Background Aurora Effect */
        .aurora-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, var(--bg-start) 0%, var(--bg-end) 100%);
            transition: background 0.5s ease;
        }
        
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: blob 10s infinite alternate;
            transition: background 0.5s ease;
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--orb-1); }
        .orb-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: var(--orb-2); animation-delay: 2s; }
        .orb-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: var(--orb-3); opacity: 0.3; animation-delay: 4s; }

        /* Glass Cards Adaptatives */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px var(--glass-shadow);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .glass-card-hover {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .glass-card-hover:hover {
            transform: translateY(-5px);
            border-color: rgba(20, 184, 166, 0.4);
            box-shadow: 0 20px 40px -10px rgba(20, 184, 166, 0.15);
        }
        /* Mode jour hover plus marqu√© */
        html:not(.dark) .glass-card-hover:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #14b8a6; }

        /* Loader Radar */
        .radar-loader {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(20, 184, 166, 0.3);
            position: relative;
        }
        .radar-loader::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 100%; height: 100%;
            background: conic-gradient(transparent, rgba(20, 184, 166, 0.8));
            border-radius: 50%;
            transform-origin: 0 0;
            animation: spin 1.5s linear infinite;
            transform: translate(-50%, -50%);
            mask-image: radial-gradient(transparent 40%, black 41%);
            -webkit-mask-image: radial-gradient(transparent 40%, black 41%);
        }
    </style>
</head>
<body class="antialiased selection:bg-spirit-500 selection:text-white">

    <!-- Background Anim√© -->
    <div class="aurora-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- Conteneur Principal -->
    <div class="relative w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        
        <!-- En-t√™te -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6 relative z-10">
            <div class="text-center md:text-left">
                <div class="flex items-center justify-center md:justify-start gap-3 mb-2">
                    <span class="flex h-3 w-3 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-spirit-500 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-spirit-500"></span>
                    </span>
                    <span class="text-xs uppercase tracking-[0.2em] text-spirit-500 font-bold">Syst√®me Actif</span>
                </div>
                <h1 class="text-5xl md:text-6xl font-serif font-medium text-transparent bg-clip-text bg-gradient-to-r from-slate-800 to-spirit-600 dark:from-white dark:via-spirit-100 dark:to-spirit-500 leading-tight transition-all duration-500">
                    Spirit-Nav
                </h1>
                <p class="mt-2 text-slate-600 dark:text-gray-400 font-light max-w-md">L'intelligence g√©ospatiale au service de la puret√© du c≈ìur.</p>
            </div>
            
            <div class="flex gap-4 items-center">
                <button id="theme-toggle" class="glass-panel p-3 rounded-full text-slate-600 dark:text-gray-400 hover:text-spirit-600 dark:hover:text-white hover:bg-white/20 transition-all shadow-sm" aria-label="Changer le th√®me">
                    <!-- Icone Soleil (Visible en Dark Mode) -->
                    <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <!-- Icone Lune (Visible en Light Mode) -->
                    <svg id="theme-icon-dark" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <!-- Avertissement √âl√©gant -->
        <div class="glass-panel rounded-2xl p-6 mb-12 border-l-4 border-l-amber-500/50 flex gap-4 items-start relative overflow-hidden group">
            <div class="absolute inset-0 bg-gradient-to-r from-amber-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            <div class="text-amber-500 dark:text-amber-400 mt-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
                <h2 class="text-lg font-serif text-slate-800 dark:text-amber-100 mb-1 font-semibold">Note sur l'Intention (Niyyah)</h2>
                <p class="text-sm text-slate-600 dark:text-gray-400 font-light leading-relaxed">
                    Cet outil est une boussole pour le <strong class="text-slate-900 dark:text-white">Tafakkur</strong> (contemplation). Les lieux ne sont que des d√©cors ; seul Allah (SWT) d√©tient le pouvoir.
                </p>
            </div>
        </div>
        
        <!-- Bento Grid Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-12">
            
            <!-- Rappel du Jour (Large) -->
            <div class="col-span-1 md:col-span-7 glass-panel rounded-3xl p-8 flex flex-col justify-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-32 bg-spirit-500/10 rounded-full blur-3xl -mr-16 -mt-16"></div>
                <span class="text-spirit-600 dark:text-spirit-500 text-xs font-bold tracking-widest uppercase mb-4">Ayat du Jour</span>
                <div id="verse-of-the-day" class="font-serif text-2xl md:text-3xl text-slate-800 dark:text-white leading-relaxed italic z-10 transition-colors">
                    Chargement de l'inspiration...
                </div>
                <div class="mt-6 h-1 w-20 bg-spirit-500/30 rounded-full"></div>
            </div>

            <!-- Boussole Qibla (Carr√©) -->
            <div class="col-span-1 md:col-span-5 glass-panel rounded-3xl p-6 flex flex-col items-center justify-center relative">
                <h3 class="absolute top-6 left-6 text-sm font-medium text-slate-500 dark:text-gray-400">Orientation Qibla</h3>
                
                <!-- HUD Compass Design -->
                <div id="qibla-compass-container" class="relative w-48 h-48 rounded-full border border-slate-300 dark:border-gray-700 flex items-center justify-center transition-transform duration-700 ease-out mt-4">
                    <!-- Cercle externe d√©coratif -->
                    <div class="absolute inset-0 border border-dashed border-slate-400 dark:border-gray-600 rounded-full animate-spin-slow opacity-30"></div>
                    
                    <!-- L'aiguille stylis√©e -->
                    <div id="qibla-arrow" class="absolute w-1 h-24 bg-gradient-to-t from-transparent via-spirit-600 to-slate-800 dark:via-spirit-500 dark:to-white rounded-full shadow-[0_0_15px_rgba(20,184,166,0.6)]" style="transform-origin: bottom; top: 0; left: 50%; transform: translateX(-50%);"></div>
                    
                    <!-- Centre -->
                    <div class="w-16 h-16 bg-white dark:bg-void rounded-full border border-slate-200 dark:border-gray-700 flex items-center justify-center z-10 shadow-lg transition-colors">
                        <span class="text-xl font-serif text-slate-900 dark:text-white">N</span>
                    </div>
                </div>
            </div>

            <!-- Horaires de Pri√®re -->
            <div class="col-span-1 md:col-span-12 glass-panel rounded-3xl p-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div>
                        <h3 class="text-xl font-serif text-slate-900 dark:text-white">Horloges Solaires</h3>
                        <p class="text-sm text-slate-500 dark:text-gray-500">Synchronisation c√©leste</p>
                    </div>
                    <div id="prayer-times" class="flex flex-wrap justify-center gap-4 md:gap-8 w-full md:w-auto">
                        <span class="text-slate-500 dark:text-gray-500 text-sm">Initialisation requise...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contr√¥les Flottants -->
        <div class="sticky top-4 z-40 mx-auto max-w-fit">
            <div class="glass-panel rounded-full p-2 pl-6 pr-2 flex items-center gap-4 shadow-2xl backdrop-blur-xl">
                <div class="flex items-center gap-3">
                    <label for="radius-select" class="text-xs font-bold text-slate-500 dark:text-gray-400 uppercase tracking-wider hidden sm:block">Rayon</label>
                    <select id="radius-select" class="bg-transparent text-slate-800 dark:text-white text-sm font-medium focus:outline-none cursor-pointer [&>option]:text-slate-900 [&>option]:dark:bg-void">
                        <option value="1000">1 km</option>
                        <option value="5000" selected>5 km</option>
                        <option value="10000">10 km</option>
                    </select>
                </div>
                
                <div class="h-6 w-px bg-slate-300 dark:bg-white/10 mx-2"></div>

                <button id="analyzeBtn" class="bg-slate-900 dark:bg-white text-white dark:text-void hover:bg-spirit-600 dark:hover:bg-spirit-50 text-sm font-bold py-3 px-6 rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center gap-2 group">
                    <span>Lancer le Scan</span>
                    <svg class="w-4 h-4 group-hover:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </button>
            </div>
        </div>

        <!-- Section Status -->
        <div id="status" class="text-center text-spirit-600 dark:text-spirit-400 text-sm font-mono h-12 flex items-center justify-center my-6 font-semibold"></div>
        
        <!-- R√©sultats -->
        <div id="results-header" class="hidden animate-fade-in-up">
            <div id="summary-card" class="text-center mb-10 max-w-2xl mx-auto"></div>
            
            <div class="flex justify-center flex-wrap gap-3 mb-10">
                <button class="filter-btn px-6 py-2 rounded-full text-sm font-medium border border-slate-300 dark:border-white/10 hover:bg-slate-100 dark:hover:bg-white/5 transition-colors text-slate-700 dark:text-white active-filter" data-filter="all">Tout voir</button>
                <button class="filter-btn px-6 py-2 rounded-full text-sm font-medium border border-emerald-500/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-500/10 transition-colors" data-filter="positive">Positifs</button>
                <button class="filter-btn px-6 py-2 rounded-full text-sm font-medium border border-red-500/30 text-red-600 dark:text-red-400 hover:bg-red-500/10 transition-colors" data-filter="negative">N√©gatifs</button>
                <button class="filter-btn px-6 py-2 rounded-full text-sm font-medium border border-slate-400/30 text-slate-500 dark:text-gray-400 hover:bg-slate-500/10 transition-colors" data-filter="neutral">Neutres</button>
            </div>
        </div>
        
        <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-fr">
            <!-- Les cartes sont inject√©es ici via JS -->
        </div>
        
        <footer class="text-center mt-20 pb-8 border-t border-slate-200 dark:border-white/5 pt-8">
            <p class="text-slate-500 dark:text-gray-500 font-serif italic text-sm">&copy; 2026 Spirit-Nav. Conscience Augment√©e.</p>
            <p class="text-xs text-slate-400 dark:text-gray-600 mt-2">Donn√©es OpenStreetMap & Aladhan.</p>
        </footer>
    </div>

    <script>
        // --- ELEMENTS DU DOM ---
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const radiusSelect = document.getElementById('radius-select');
        const resultsHeader = document.getElementById('results-header');
        const summaryCard = document.getElementById('summary-card');
        const prayerTimesDiv = document.getElementById('prayer-times');
        const qiblaArrow = document.getElementById('qibla-arrow');
        const qiblaCompassContainer = document.getElementById('qibla-compass-container');
        const verseOfTheDayDiv = document.getElementById('verse-of-the-day');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');

        // --- CLASSIFICATION DES LIEUX ---
        const placeClassification = {
            'place_of_worship': { type: 'positive', label: 'Lieu de Culte', icon: 'üïå', title: 'Lieu de Culte et de Pri√®re', interpretation: "Un rappel direct de nos devoirs spirituels. Un havre de paix qui facilite le Dhikr, la concentration et le repentir." },
            'park': { type: 'positive', label: 'Parc / Espace Vert', icon: 'üå≥', title: 'Espace de Contemplation Naturelle', interpretation: "La nature est un livre des signes (Ayat) d'Allah. Un lieu propice au Tafakkur, pour m√©diter sur la perfection de la cr√©ation." },
            'nature_reserve': { type: 'positive', label: 'R√©serve Naturelle', icon: 'üèûÔ∏è', title: 'Sanctuaire de la Cr√©ation Divine', interpretation: "Une opportunit√© de m√©diter sur la diversit√© de la vie, renfor√ßant la conscience de l'ordre parfait √©tabli par le Cr√©ateur." },
            'cemetery': { type: 'positive', label: 'Cimeti√®re', icon: 'ü™¶', title: 'Rappel de l\'Au-Del√†', interpretation: "Un rappel puissant de la finalit√© de cette vie (Dunya) et de l'in√©vitabilit√© de la mort, incitant √† la m√©ditation sur l'Au-Del√† (Akhira)." },
            'library': { type: 'positive', label: 'Biblioth√®que', icon: 'üìö', title: 'Source de Savoir', interpretation: "La recherche du savoir ('Ilm) est une obligation. Un lieu de calme favorisant l'√©tude et la r√©flexion pour servir Allah et la communaut√©." },
            'hospital': { type: 'positive', label: 'H√¥pital / Clinique', icon: 'üè•', title: 'Rappel de la Sant√©', interpretation: "Un lieu pour se souvenir du bienfait de la sant√© (Ni'mah), de la fragilit√© de la vie et pour invoquer la gu√©rison pour les malades." },
            'school': { type: 'positive', label: '√âcole / Universit√©', icon: 'üè´', title: 'Centre d\'Apprentissage', interpretation: "La qu√™te du savoir utile est valoris√©e. Ces lieux rappellent l'importance de l'instruction pour adorer Allah avec clairvoyance." },
            'fountain': { type: 'positive', label: 'Fontaine / Eau', icon: '‚õ≤', title: 'Source de Vie et de Puret√©', interpretation: "L'eau est un signe (Ayah) d'Allah, source de vie et de purification. Invite √† m√©diter sur la mis√©ricorde divine (Rahma)." },
            'community_centre': { type: 'positive', label: 'Centre Communautaire', icon: 'ü§ù', title: 'Lieu de Lien Social', interpretation: "Symbolise l'importance des liens communautaires et de l'entraide, un rappel de la fraternit√© en Islam." },
            'museum': { type: 'positive', label: 'Mus√©e', icon: 'üèõÔ∏è', title: 'Le√ßons de l\'Histoire', interpretation: "Un lieu pour m√©diter sur les nations pass√©es et tirer des le√ßons ('Ibra) de l'histoire, comme le Coran nous y invite." },
            'viewpoint': { type: 'positive', label: 'Point de vue', icon: 'üåÑ', title: 'Contemplation de la Grandeur', interpretation: "Offre une perspective sur l'immensit√© de la cr√©ation, ce qui inspire l'humilit√© et la glorification d'Allah (Tasbih)." },
            'halal_butcher': { type: 'neutral', label: 'Boucherie Halal', icon: 'ü•©', title: 'Rappel du Licite', interpretation: "Un rappel de l'importance de consommer ce qui est licite (Halal) et bon (Tayyib) et de la provision (Rizq) d'Allah." },
            'bar': { type: 'negative', label: 'Bar', icon: 'üç∑', title: 'Lieu de Futilit√©', interpretation: "Associ√© √† la consommation d'alcool, interdit en Islam. Un rappel de se pr√©server des tentations (Fitna) et des environnements qui banalisent les p√©ch√©s." },
            'nightclub': { type: 'negative', label: 'Bo√Æte de nuit', icon: 'üíÉ', title: 'Centre de Distraction', interpretation: "Source majeure de tentation, √©loignant le c≈ìur du souvenir d'Allah. Incite √† la vigilance et √† pr√©server sa pudeur (Haya)." },
            'casino': { type: 'negative', label: 'Casino', icon: 'üé≤', title: 'Foyer de Hasard', interpretation: "Les jeux de hasard sont interdits. Un avertissement contre la cupidit√© et un rappel de gagner sa subsistance de mani√®re licite." },
            'mall': { type: 'negative', label: 'Centre Commercial', icon: 'üõçÔ∏è', title: 'Temple du Mat√©rialisme', interpretation: "Stimule le consum√©risme et l'amour des biens mat√©riels (Dunya), ce qui peut d√©tourner des priorit√©s spirituelles. Rappelle l'importance de la mod√©ration." },
            'stadium': { type: 'negative', label: 'Stade', icon: 'üèüÔ∏è', title: 'Lieu d\'Inattention', interpretation: "Peut √™tre un lieu de distraction (Lahw) et de fanatisme, d√©tournant des priorit√©s spirituelles. Incite √† la prudence quant √† la gestion de son temps." },
            'cinema': { type: 'negative', label: 'Cin√©ma', icon: 'üé¨', title: 'Source de Divertissements Vains', interpretation: "Diffuse souvent des contenus contraires √† la pudeur et aux valeurs islamiques. Rappelle de pr√©server son regard et son c≈ìur." },
            'marketplace': { type: 'neutral', label: 'March√©', icon: 'üß∫', title: 'Lieu de Commerce', interpretation: "Peut √™tre un lieu de tromperie et de distraction. Rappelle l'importance de l'honn√™tet√© et du souvenir d'Allah m√™me dans l'agitation." },
        };
        const classificationAliases = { 'university': 'school', 'water': 'fountain', 'butcher': 'halal_butcher' };

        // --- INITIALISATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); // Initialise le th√®me au chargement
            updateVerseOfTheDay();
            analyzeBtn.addEventListener('click', startAnalysis);
            themeToggle.addEventListener('click', toggleTheme);
            
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation, true);
            }
        });

        // --- FONCTIONS PRINCIPALES DE G√âOLOCALISATION ---
        function startAnalysis() {
            resultsDiv.innerHTML = '';
            resultsHeader.classList.add('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="radar-loader w-5 h-5 border-[1px]"></div>'; 
            statusDiv.innerHTML = '<span class="animate-pulse">Acquisition de la position GPS...</span>';
            
            if (!navigator.geolocation) {
                useSimulationMode("Votre navigateur ne supporte pas la g√©olocalisation.");
                return;
            }

            // Options pour haute pr√©cision
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(analyzeLocation, handleGeoError, options);
        }

        function handleGeoError(error) {
            let msg = "Erreur de localisation.";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    msg = "Permission refus√©e. Activez la localisation dans votre navigateur.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    msg = "Position indisponible.";
                    break;
                case error.TIMEOUT:
                    msg = "D√©lai d'attente d√©pass√©.";
                    break;
            }
            // On propose de simuler
            statusDiv.innerHTML = `<span class="text-amber-500 font-bold">${msg}</span>`;
            setTimeout(() => {
                const useSim = confirm(`${msg} Voulez-vous utiliser le mode simulation (Paris) ?`);
                if(useSim) useSimulationMode("Mode simulation activ√©.");
                else resetBtn();
            }, 500);
        }

        function resetBtn() {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `<span>Lancer le Scan</span><svg class="w-4 h-4 group-hover:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`;
        }

        async function analyzeLocation(position) {
            const { latitude, longitude } = position.coords;
            statusDiv.innerHTML = `<span class="text-spirit-600 dark:text-spirit-400">Position trouv√©e. Analyse en cours...</span>`;
            await performAnalysis(latitude, longitude);
        }

        function useSimulationMode(msg) {
            statusDiv.innerHTML = `<span class="text-amber-500">${msg}</span>`;
            // Coordonn√©es de Paris par d√©faut
            performAnalysis(48.8566, 2.3522); 
        }

        async function performAnalysis(lat, lon) {
             try {
                await Promise.all([
                    fetchPlacesAndDisplay(lat, lon),
                    updateDashboard(lat, lon)
                ]);
            } catch (error) {
                console.error("Erreur lors de l'analyse:", error);
                statusDiv.textContent = "Interf√©rence d√©tect√©e (Erreur API).";
            } finally {
                resetBtn();
            }
        }
        
        async function fetchPlacesAndDisplay(lat, lon) {
             try {
                const places = await fetchPlaces(lat, lon);
                const placesWithDistance = places.map(place => ({
                    ...place,
                    distance: calculateDistance(lat, lon, place.lat, place.lon)
                })).sort((a, b) => a.distance - b.distance);

                displayResults(placesWithDistance);
                
                if (placesWithDistance.length === 0) {
                   statusDiv.textContent = "Zone neutre. Aucun point d'int√©r√™t majeur d√©tect√©.";
                } else {
                   statusDiv.textContent = "";
                }
             } catch (e) {
                 console.error(e);
                 statusDiv.textContent = "Erreur de connexion aux donn√©es cartographiques.";
             }
        }

        async function fetchPlaces(lat, lon) {
            const radius = radiusSelect.value;
            const query = `
                [out:json][timeout:25];
                (
                  nwr["amenity"~"^(place_of_worship|bar|nightclub|casino|library|hospital|school|university|fountain|community_centre|cinema|marketplace|butcher)$"](around:${radius},${lat},${lon});
                  nwr["leisure"~"^(park|nature_reserve|stadium)$"](around:${radius},${lat},${lon});
                  nwr["landuse"="cemetery"](around:${radius},${lat},${lon});
                  nwr["shop"~"mall"](around:${radius},${lat},${lon});
                  nwr["tourism"~"^(museum|viewpoint)$"](around:${radius},${lat},${lon});
                  nwr["natural"="water"](around:${radius},${lat},${lon});
                );
                out center;`;

            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erreur API Overpass: ${response.statusText}`);
            const data = await response.json();
            
            return data.elements.map(el => {
                const tags = el.tags || {};
                let classificationKey = Object.keys(tags).map(k => tags[k]).find(val => placeClassification[val] || classificationAliases[val]);

                if (tags.amenity === 'butcher' && tags['diet:halal'] === 'yes') {
                    classificationKey = 'halal_butcher';
                }

                if (!classificationKey) return null;

                const finalKey = classificationAliases[classificationKey] || classificationKey;
                const classification = placeClassification[finalKey];
                if (!classification) return null;

                const placeLat = el.center ? el.center.lat : el.lat;
                const placeLon = el.center ? el.center.lon : el.lon;

                // --- LOGIQUE AM√âLIOR√âE DU NOM ---
                let niceName = tags['name:fr'] || tags.name || tags.alt_name;
                
                // Si pas de nom, on construit un nom descriptif plus intelligent
                if (!niceName) {
                     if (tags.religion) {
                         niceName = `${classification.label} (${tags.religion}${tags.denomination ? ' - ' + tags.denomination : ''})`;
                     } else {
                         niceName = classification.label;
                     }
                }

                // --- EXTRACTION DES D√âTAILS ---
                const details = [];
                if (tags['addr:street']) details.push(`${tags['addr:street']} ${tags['addr:housenumber'] || ''}`);
                if (tags['addr:city']) details.push(tags['addr:city']);
                const fullAddress = details.join(', ');
                
                const extraInfo = [];
                if (tags.religion && !niceName.includes(tags.religion)) extraInfo.push(tags.religion);
                if (tags.denomination && !niceName.includes(tags.denomination)) extraInfo.push(tags.denomination);
                if (tags.opening_hours) extraInfo.push("üïí Horaires dispo");
                if (tags.website) extraInfo.push("üåê Site web");
                if (tags.phone) extraInfo.push("üìû T√©l√©phone");

                return {
                    name: niceName,
                    address: fullAddress,
                    tags: tags, // On garde les tags pour v√©rifier la description
                    extraInfo: extraInfo,
                    ...classification,
                    lat: placeLat,
                    lon: placeLon
                };
            }).filter(p => p && p.lat && p.lon);
        }

        function displayResults(places) {
            resultsDiv.innerHTML = '';
            resultsHeader.classList.remove('hidden');

            const counts = { positive: 0, negative: 0, neutral: 0 };
            places.forEach(p => counts[p.type]++);
            
            let summaryHTML = `<h3 class="text-3xl font-serif text-slate-900 dark:text-white mb-2">Analyse Spectrale</h3>`;
            if (places.length > 0) {
                 summaryHTML += `<p class="text-slate-600 dark:text-gray-400 font-light text-lg">D√©tection de <span class="text-emerald-600 dark:text-emerald-400 font-medium">${counts.positive} points de lumi√®re</span>, <span class="text-red-600 dark:text-red-400 font-medium">${counts.negative} zones de trouble</span> et <span class="text-slate-500 dark:text-gray-400 font-medium">${counts.neutral} neutres</span>.</p>`;
                if (counts.positive > counts.negative) {
                    summaryHTML += `<div class="mt-4 inline-block px-4 py-1 rounded-full bg-emerald-100 dark:bg-emerald-500/10 border border-emerald-500/20 text-emerald-700 dark:text-emerald-400 text-sm">Environnement Favorable</div>`;
                } else {
                     summaryHTML += `<div class="mt-4 inline-block px-4 py-1 rounded-full bg-red-100 dark:bg-red-500/10 border border-red-500/20 text-red-700 dark:text-red-400 text-sm">Vigilance Requise</div>`;
                }
            } else {
                 summaryHTML += `<p class="text-gray-400">Le silence r√®gne. Aucun signal d√©tect√©.</p>`;
            }
            summaryCard.innerHTML = summaryHTML;

            const typeStyles = {
                positive: 'border-emerald-500/30 hover:shadow-[0_0_30px_-5px_rgba(16,185,129,0.3)]',
                negative: 'border-red-500/30 hover:shadow-[0_0_30px_-5px_rgba(239,68,68,0.3)]',
                neutral: 'border-slate-300 dark:border-gray-500/30 hover:shadow-[0_0_30px_-5px_rgba(107,114,128,0.3)]'
            };

            places.slice(0, 21).forEach((place, index) => {
                const distance = place.distance < 1 ? `${Math.round(place.distance * 1000)}m` : `${place.distance.toFixed(1)}km`;
                const mapLink = `https://www.openstreetmap.org/?mlat=${place.lat}&mlon=${place.lon}#map=17/${place.lat}/${place.lon}`;
                const delay = index * 50;

                // Construction HTML pour l'adresse et les badges
                const addressHtml = place.address ? 
                    `<div class="flex items-start text-xs text-slate-500 dark:text-gray-400 mb-2 mt-1">
                        <svg class="w-3 h-3 mr-1 mt-0.5 flex-shrink-0 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>${place.address}</span>
                    </div>` : '';

                const badgesHtml = place.extraInfo && place.extraInfo.length > 0 
                    ? `<div class="flex flex-wrap gap-1.5 mb-4 border-b border-slate-100 dark:border-white/5 pb-3">
                        ${place.extraInfo.map(info => `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-gray-300 border border-slate-200 dark:border-white/10">${info}</span>`).join('')}
                       </div>` 
                    : '<div class="mb-4 border-b border-slate-100 dark:border-white/5 pb-1"></div>';

                // Description personnalis√©e ou standard
                const descriptionContent = place.tags.description 
                    ? `<p class="text-sm text-slate-700 dark:text-gray-200 italic mb-2">"${place.tags.description}"</p>` 
                    : '';

                const card = `
                    <div class="result-card glass-panel glass-card-hover rounded-2xl p-6 flex flex-col h-full border ${typeStyles[place.type]}" data-type="${place.type}" style="animation: fadeInUp 0.5s ease forwards ${delay}ms">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="w-12 h-12 rounded-full bg-white/40 dark:bg-white/5 flex items-center justify-center text-2xl border border-white/20 dark:border-white/10 shadow-sm">
                                    ${place.icon}
                                </div>
                                <span class="text-xs font-mono text-slate-500 dark:text-gray-500 bg-white/50 dark:bg-void/50 px-2 py-1 rounded border border-white/10">${distance}</span>
                            </div>
                            
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white leading-tight">${place.name}</h3>
                            ${addressHtml}
                            ${badgesHtml}
                            
                            <div class="prose prose-invert">
                                ${descriptionContent}
                                <p class="text-sm text-slate-600 dark:text-gray-300 font-light leading-relaxed">
                                    <strong class="text-xs uppercase tracking-wider opacity-70 block mb-1 text-slate-400 dark:text-gray-500">${place.label}</strong>
                                    ${place.interpretation}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-6 pt-4 border-t border-slate-200 dark:border-white/5">
                            <button class="share-btn flex-1 py-2 rounded-lg bg-white/40 dark:bg-white/5 hover:bg-white/60 dark:hover:bg-white/10 text-xs text-slate-700 dark:text-white transition-colors flex items-center justify-center gap-2 font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                                Partager
                            </button>
                            <a href="${mapLink}" target="_blank" class="flex-1 py-2 rounded-lg bg-spirit-100 dark:bg-spirit-500/20 hover:bg-spirit-200 dark:hover:bg-spirit-500/30 text-spirit-700 dark:text-spirit-400 text-xs text-center transition-colors flex items-center justify-center gap-2 font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                                Carte
                            </a>
                        </div>
                    </div>`;
                resultsDiv.innerHTML += card;
            });
            setupCardInteractions();
        }

        function setupCardInteractions() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const filter = e.target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-white', 'text-slate-900', 'shadow-lg');
                    b.classList.add('text-slate-500');
                });
                e.target.classList.add('bg-white', 'text-slate-900', 'shadow-lg');
                e.target.classList.remove('text-slate-500');
                
                document.querySelectorAll('.result-card').forEach(card => {
                    if(filter === 'all' || card.dataset.type === filter) {
                        card.style.display = 'flex';
                        card.style.animation = 'none';
                        card.offsetHeight; 
                        card.style.animation = 'fadeInUp 0.3s ease forwards';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }));
            
            document.querySelector('.filter-btn[data-filter="all"]').click();

            // Share logic am√©lior√©e pour mobile & iframe
            document.querySelectorAll('.share-btn').forEach(btn => btn.addEventListener('click', e => {
                const card = e.target.closest('.result-card');
                const title = card.querySelector('h3').textContent;
                const shareText = `Guidance Spirit-Nav : "${title}" √† proximit√©. #SpiritNav`;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareText).then(showCopied).catch(fallbackCopy);
                } else {
                    fallbackCopy();
                }

                function showCopied() {
                    const btnContent = btn.innerHTML;
                    btn.innerHTML = `<span class="text-emerald-500">Copi√© !</span>`;
                    setTimeout(() => { btn.innerHTML = btnContent; }, 2000);
                }

                function fallbackCopy() {
                    const textArea = document.createElement("textarea");
                    textArea.value = shareText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showCopied();
                    } catch (err) {
                        console.error('Fallback copy failed', err);
                    }
                    document.body.removeChild(textArea);
                }
            }));
        }
        
        // --- DASHBOARD UPDATES ---
        async function updateDashboard(lat, lon) {
            try {
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                const dateString = `${dd}-${mm}-${yyyy}`;

                const response = await fetch(`https://api.aladhan.com/v1/timings/${dateString}?latitude=${lat}&longitude=${lon}&method=4`);
                if (!response.ok) throw new Error('API Timeout');
                const data = await response.json();
                const timings = data.data.timings;
                
                const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                let nextPrayerName = '';
                
                for (const prayer of prayerOrder) {
                    if (timings[prayer] > currentTime) {
                        nextPrayerName = prayer;
                        break;
                    }
                }
                if (!nextPrayerName) nextPrayerName = 'Fajr';

                prayerTimesDiv.innerHTML = prayerOrder.map(prayer => {
                    const isNext = prayer === nextPrayerName;
                    const activeClass = isNext ? 'bg-spirit-600 dark:bg-spirit-500 text-white border-spirit-400 shadow-[0_0_15px_rgba(20,184,166,0.5)] scale-110' : 'bg-white/40 dark:bg-white/5 text-slate-500 dark:text-gray-400 border-transparent';
                    
                    return `
                        <div class="flex flex-col items-center justify-center w-20 py-3 rounded-2xl border ${activeClass} transition-all duration-300 shadow-sm">
                            <span class="text-xs font-bold uppercase tracking-widest mb-1 opacity-80">${prayer}</span>
                            <span class="text-lg font-serif">${timings[prayer]}</span>
                        </div>`;
                }).join('');

            } catch (err) {
                prayerTimesDiv.innerHTML = '<span class="text-red-400 text-sm">Erreur synchro horaires</span>';
                console.error(err);
            }
            
            const qiblaDirection = calculateQibla(lat, lon);
            qiblaArrow.style.transform = `translateX(-50%) rotate(${qiblaDirection}deg)`;
        }
        
        function updateVerseOfTheDay() {
            const verses = [
                { text: "En v√©rit√©, dans la cr√©ation des cieux et de la terre... il y a certes des signes pour les dou√©s d'intelligence.", ref: "Coran 3:190" },
                { text: "Et c'est Lui qui vous a assign√© les √©toiles, pour que, par elles, vous vous guidiez dans les t√©n√®bres...", ref: "Coran 6:97" },
                { text: "Une heure de m√©ditation vaut mieux que soixante ans d'adoration.", ref: "Hassan al-Basri" }
            ];
            const verse = verses[Math.floor(Math.random() * verses.length)];
            verseOfTheDayDiv.innerHTML = `"${verse.text}" <br><span class="block mt-4 text-sm text-spirit-600 dark:text-spirit-400 font-sans not-italic tracking-wider uppercase">‚Äî ${verse.ref}</span>`;
        }

        // --- OUTILS TECH ---
        function handleOrientation(event) {
            const heading = event.webkitCompassHeading || event.alpha;
            if (heading !== null) {
                qiblaCompassContainer.style.transform = `rotate(${-heading}deg)`;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        function calculateQibla(lat, lon) {
            const PI = Math.PI;
            const latK = 21.4225 * PI / 180.0;
            const lonK = 39.8264 * PI / 180.0;
            const lat_ = lat * PI / 180.0;
            const lon_ = lon * PI / 180.0;
            const dLon = lonK - lon_;
            const qibla = Math.atan2(Math.sin(dLon), (Math.cos(lat_) * Math.tan(latK)) - (Math.sin(lat_) * Math.cos(dLon)));
            return qibla * 180.0 / PI;
        }

        // --- LOGIQUE TH√àME JOUR/NUIT CORRIG√âE ---
        function initTheme() {
            // V√©rifie le localStorage ou les pr√©f√©rences syst√®me
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcons();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons();
        }

        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            themeIconLight.classList.toggle('hidden', isDark); // Affiche le soleil (light) quand on est en dark pour passer en light
            themeIconDark.classList.toggle('hidden', !isDark); // Affiche la lune (dark) quand on est en light pour passer en dark
            
            // Inversion de logique visuelle : si on est en Dark, on affiche l'icone Soleil pour dire "Passer en Light"
            // Le code original affichait l'icone du mode ACTUEL, ce qui peut √™tre confus. 
            // Ici : Dark Mode actif -> Icone Soleil visible. Light Mode actif -> Icone Lune visible.
            if (isDark) {
               themeIconLight.classList.remove('hidden');
               themeIconDark.classList.add('hidden');
            } else {
               themeIconLight.classList.add('hidden');
               themeIconDark.classList.remove('hidden');
            }
        }
        
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>
