<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Spirituel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card-glow-positive { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4), 0 0 5px rgba(34, 197, 94, 0.6); }
        .card-glow-negative { box-shadow: 0 0 15px rgba(239, 68, 68, 0.4), 0 0 5px rgba(239, 68, 68, 0.6); }
        .card-glow-neutral { box-shadow: 0 0 15px rgba(107, 114, 128, 0.3), 0 0 5px rgba(107, 114, 128, 0.5); }
        .loader {
            border: 4px solid #4a5568; /* gray-700 */
            border-top: 4px solid #38b2ac; /* teal-400 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        html.light .loader {
            border: 4px solid #e2e8f0; /* gray-200 */
            border-top: 4px solid #4299e1; /* blue-500 */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #qibla-compass-container { transition: transform 0.5s ease-out; }
        #qibla-arrow { transition: transform 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="w-full max-w-6xl mx-auto p-4 md:p-6">
        <!-- En-t√™te -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-sky-500">Tableau de Bord Spirituel</h1>
                <p class="text-gray-400">Un outil de r√©flexion et d'aide au quotidien.</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
                <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-dark" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </header>

        <!-- Avertissement Islamique -->
        <div class="bg-gray-800 border border-yellow-500 rounded-lg p-6 mb-6 text-left transition-colors duration-300">
            <h2 class="text-xl font-bold text-yellow-400 mb-2">Note importante sur la Croyance (Aqida)</h2>
            <p class="text-gray-300">
                Cet outil est symbolique pour encourager la contemplation (<strong class="font-semibold text-white">Tafakkur</strong>). Rappelez-vous que seul Allah (SWT) d√©tient tout pouvoir. Les lieux n'ont aucune influence propre; ils peuvent simplement faciliter ou entraver le rappel d'Allah (<strong class="font-semibold text-white">Dhikr</strong>).
            </p>
        </div>
        
        <!-- Tableau de Bord Quotidien -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
            <!-- Horaires de Pri√®re -->
            <div class="bg-gray-800 rounded-lg p-4 transition-colors duration-300">
                <h3 class="font-bold text-lg mb-2 text-emerald-400">Horaires de Pri√®re (auto)</h3>
                <div id="prayer-times" class="text-gray-300 space-y-1">Cliquez sur "Analyser" pour les obtenir.</div>
            </div>
            <!-- Boussole Qibla -->
            <div class="bg-gray-800 rounded-lg p-4 flex flex-col items-center justify-center transition-colors duration-300">
                <h3 class="font-bold text-lg mb-2 text-emerald-400">Direction de la Qibla</h3>
                <div id="qibla-compass-container" class="relative w-24 h-24 bg-gray-700 rounded-full flex items-center justify-center">
                    <div id="qibla-arrow" class="absolute w-2 h-12 bg-red-500 rounded-t-full" style="transform-origin: bottom; top: 0;"></div>
                    <div class="absolute text-white font-bold">N</div>
                </div>
            </div>
            <!-- Rappel du Jour -->
            <div class="bg-gray-800 rounded-lg p-4 flex flex-col justify-center transition-colors duration-300">
                <h3 class="font-bold text-lg mb-2 text-emerald-400">Rappel du Jour</h3>
                <div id="verse-of-the-day" class="text-gray-300 italic">Chargement...</div>
            </div>
        </div>

        <!-- Contr√¥les d'Analyse -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 flex flex-col sm:flex-row items-center justify-center gap-4 transition-colors duration-300">
             <div class="w-full sm:w-auto">
                <label for="radius-select" class="font-semibold mr-2 text-gray-300">Rayon de recherche :</label>
                <select id="radius-select" class="bg-gray-700 text-white p-2 rounded-md">
                    <option value="1000">1 km</option>
                    <option value="5000" selected>5 km</option>
                    <option value="10000">10 km</option>
                </select>
            </div>
            <button id="analyzeBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-full transition-transform duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">
                Analyser les Environs
            </button>
        </div>

        <!-- Section des R√©sultats -->
        <div id="status" class="text-gray-400 h-8 flex items-center justify-center mb-4"></div>
        
        <div id="results-header" class="hidden">
            <div id="summary-card" class="bg-gray-800 rounded-lg p-6 mb-6 text-center transition-colors duration-300"></div>
            <div class="flex justify-center gap-2 mb-6">
                <button class="filter-btn bg-gray-700 text-white py-1 px-3 rounded-full" data-filter="all">Tous</button>
                <button class="filter-btn bg-gray-700 text-white py-1 px-3 rounded-full" data-filter="positive">Positifs</button>
                <button class="filter-btn bg-gray-700 text-white py-1 px-3 rounded-full" data-filter="negative">N√©gatifs</button>
                <button class="filter-btn bg-gray-700 text-white py-1 px-3 rounded-full" data-filter="neutral">Neutres</button>
            </div>
        </div>
        
        <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left"></div>
    </div>

    <footer class="text-center text-gray-500 mt-12 pb-6">
        <p>&copy; 2024 - Tableau de Bord Spirituel. Louange √† Allah, Seigneur des Mondes.</p>
        <p class="text-xs">Donn√©es cartographiques &copy; contributeurs d'OpenStreetMap.</p>
    </footer>

    <script>
        // --- ELEMENTS DU DOM ---
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const radiusSelect = document.getElementById('radius-select');
        const resultsHeader = document.getElementById('results-header');
        const summaryCard = document.getElementById('summary-card');
        const prayerTimesDiv = document.getElementById('prayer-times');
        const qiblaArrow = document.getElementById('qibla-arrow');
        const qiblaCompassContainer = document.getElementById('qibla-compass-container');
        const verseOfTheDayDiv = document.getElementById('verse-of-the-day');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');

        // --- CLASSIFICATION DES LIEUX (√âTENDUE) ---
        const placeClassification = {
            'place_of_worship': { type: 'positive', label: 'Lieu de Culte', icon: 'üïå', title: 'Lieu de Culte et de Pri√®re', interpretation: "Un rappel direct de nos devoirs spirituels. Un havre de paix qui facilite le Dhikr, la concentration et le repentir." },
            'park': { type: 'positive', label: 'Parc / Espace Vert', icon: 'üå≥', title: 'Espace de Contemplation Naturelle', interpretation: "La nature est un livre des signes (Ayat) d'Allah. Un lieu propice au Tafakkur, pour m√©diter sur la perfection de la cr√©ation." },
            'nature_reserve': { type: 'positive', label: 'R√©serve Naturelle', icon: 'üèûÔ∏è', title: 'Sanctuaire de la Cr√©ation Divine', interpretation: "Une opportunit√© de m√©diter sur la diversit√© de la vie, renfor√ßant la conscience de l'ordre parfait √©tabli par le Cr√©ateur." },
            'cemetery': { type: 'positive', label: 'Cimeti√®re', icon: 'ü™¶', title: 'Rappel de l\'Au-Del√†', interpretation: "Un rappel puissant de la finalit√© de cette vie (Dunya) et de l'in√©vitabilit√© de la mort, incitant √† la m√©ditation sur l'Au-Del√† (Akhira)." },
            'library': { type: 'positive', label: 'Biblioth√®que', icon: 'üìö', title: 'Source de Savoir', interpretation: "La recherche du savoir ('Ilm) est une obligation. Un lieu de calme favorisant l'√©tude et la r√©flexion pour servir Allah et la communaut√©." },
            'hospital': { type: 'positive', label: 'H√¥pital / Clinique', icon: 'üè•', title: 'Rappel de la Sant√©', interpretation: "Un lieu pour se souvenir du bienfait de la sant√© (Ni'mah), de la fragilit√© de la vie et pour invoquer la gu√©rison pour les malades." },
            'school': { type: 'positive', label: '√âcole / Universit√©', icon: 'üè´', title: 'Centre d\'Apprentissage', interpretation: "La qu√™te du savoir utile est valoris√©e. Ces lieux rappellent l'importance de l'instruction pour adorer Allah avec clairvoyance." },
            'fountain': { type: 'positive', label: 'Fontaine / Eau', icon: '‚õ≤', title: 'Source de Vie et de Puret√©', interpretation: "L'eau est un signe (Ayah) d'Allah, source de vie et de purification. Invite √† m√©diter sur la mis√©ricorde divine (Rahma)." },
            'community_centre': { type: 'positive', label: 'Centre Communautaire', icon: 'ü§ù', title: 'Lieu de Lien Social', interpretation: "Symbolise l'importance des liens communautaires et de l'entraide, un rappel de la fraternit√© en Islam." },
            'museum': { type: 'positive', label: 'Mus√©e', icon: 'üèõÔ∏è', title: 'Le√ßons de l\'Histoire', interpretation: "Un lieu pour m√©diter sur les nations pass√©es et tirer des le√ßons ('Ibra) de l'histoire, comme le Coran nous y invite." },
            'viewpoint': { type: 'positive', label: 'Point de vue', icon: 'üåÑ', title: 'Contemplation de la Grandeur', interpretation: "Offre une perspective sur l'immensit√© de la cr√©ation, ce qui inspire l'humilit√© et la glorification d'Allah (Tasbih)." },
            'halal_butcher': { type: 'neutral', label: 'Boucherie Halal', icon: 'ü•©', title: 'Rappel du Licite', interpretation: "Un rappel de l'importance de consommer ce qui est licite (Halal) et bon (Tayyib) et de la provision (Rizq) d'Allah." },
            'bar': { type: 'negative', label: 'Bar', icon: 'üç∑', title: 'Lieu de Futilit√©', interpretation: "Associ√© √† la consommation d'alcool, interdit en Islam. Un rappel de se pr√©server des tentations (Fitna) et des environnements qui banalisent les p√©ch√©s." },
            'nightclub': { type: 'negative', label: 'Bo√Æte de nuit', icon: 'üíÉ', title: 'Centre de Distraction', interpretation: "Source majeure de tentation, √©loignant le c≈ìur du souvenir d'Allah. Incite √† la vigilance et √† pr√©server sa pudeur (Haya)." },
            'casino': { type: 'negative', label: 'Casino', icon: 'üé≤', title: 'Foyer de Hasard', interpretation: "Les jeux de hasard sont interdits. Un avertissement contre la cupidit√© et un rappel de gagner sa subsistance de mani√®re licite." },
            'mall': { type: 'negative', label: 'Centre Commercial', icon: 'üõçÔ∏è', title: 'Temple du Mat√©rialisme', interpretation: "Stimule le consum√©risme et l'amour des biens mat√©riels (Dunya), ce qui peut d√©tourner des priorit√©s spirituelles. Rappelle l'importance de la mod√©ration." },
            'stadium': { type: 'negative', label: 'Stade', icon: 'üèüÔ∏è', title: 'Lieu d\'Inattention', interpretation: "Peut √™tre un lieu de distraction (Lahw) et de fanatisme, d√©tournant des priorit√©s spirituelles. Incite √† la prudence quant √† la gestion de son temps." },
            'cinema': { type: 'negative', label: 'Cin√©ma', icon: 'üé¨', title: 'Source de Divertissements Vains', interpretation: "Diffuse souvent des contenus contraires √† la pudeur et aux valeurs islamiques. Rappelle de pr√©server son regard et son c≈ìur." },
            'marketplace': { type: 'neutral', label: 'March√©', icon: 'üß∫', title: 'Lieu de Commerce', interpretation: "Peut √™tre un lieu de tromperie et de distraction. Rappelle l'importance de l'honn√™tet√© et du souvenir d'Allah m√™me dans l'agitation." },
        };
        const classificationAliases = { 'university': 'school', 'water': 'fountain', 'butcher': 'halal_butcher' };

        // --- INITIALISATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            updateVerseOfTheDay();
            analyzeBtn.addEventListener('click', startAnalysis);
            themeToggle.addEventListener('click', toggleTheme);
            document.querySelector('.filter-btn[data-filter="all"]').classList.add('bg-emerald-600');
            
            // CORRECTION: Ajout de la boussole dynamique pour les appareils mobiles
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation, true);
            }
        });

        // --- FONCTIONS PRINCIPALES ---
        function startAnalysis() {
            resultsDiv.innerHTML = '';
            resultsHeader.classList.add('hidden');
            analyzeBtn.disabled = true;
            statusDiv.innerHTML = '<div class="loader"></div><span class="ml-2">Demande de votre localisation...</span>';
            
            if (!navigator.geolocation) {
                statusDiv.textContent = "La g√©olocalisation n'est pas support√©e par votre navigateur.";
                analyzeBtn.disabled = false;
                return;
            }
            navigator.geolocation.getCurrentPosition(analyzeLocation, handleError);
        }

        async function analyzeLocation(position) {
            const { latitude, longitude } = position.coords;
            
            statusDiv.innerHTML = '<div class="loader"></div><span class="ml-2">Analyse des donn√©es en cours...</span>';
            try {
                // Lancer les t√¢ches en parall√®le pour plus de rapidit√©
                await Promise.all([
                    fetchPlacesAndDisplay(latitude, longitude),
                    updateDashboard(latitude, longitude)
                ]);
            } catch (error) {
                console.error("Erreur lors de l'analyse:", error);
                statusDiv.textContent = "Erreur lors de la communication avec les services externes.";
            } finally {
                analyzeBtn.disabled = false;
            }
        }
        
        async function fetchPlacesAndDisplay(lat, lon) {
             const places = await fetchPlaces(lat, lon);
             const placesWithDistance = places.map(place => ({
                ...place,
                distance: calculateDistance(lat, lon, place.lat, place.lon)
            })).sort((a, b) => a.distance - b.distance);

            displayResults(placesWithDistance);
            
            if (placesWithDistance.length === 0) {
               statusDiv.textContent = "Aucun lieu notable identifi√©. Votre environnement est consid√©r√© comme neutre.";
            } else {
               statusDiv.textContent = "Analyse termin√©e.";
            }
        }

        async function fetchPlaces(lat, lon) {
            const radius = radiusSelect.value;
            const query = `
                [out:json][timeout:30];
                (
                  node["amenity"~"place_of_worship|bar|nightclub|casino|library|hospital|school|university|fountain|community_centre|cinema|marketplace|butcher"](around:${radius},${lat},${lon});
                  way["amenity"~"place_of_worship|bar|nightclub|casino|library|hospital|school|university|fountain|community_centre|cinema|marketplace|butcher"](around:${radius},${lat},${lon});
                  node["leisure"~"park|nature_reserve|stadium"](around:${radius},${lat},${lon});
                  way["leisure"~"park|nature_reserve|stadium"](around:${radius},${lat},${lon});
                  node["landuse"="cemetery"](around:${radius},${lat},${lon});
                  way["landuse"="cemetery"](around:${radius},${lat},${lon});
                  node["shop"~"mall"](around:${radius},${lat},${lon});
                  way["shop"~"mall"](around:${radius},${lat},${lon});
                  node["tourism"~"museum|viewpoint"](around:${radius},${lat},${lon});
                  way["tourism"~"museum|viewpoint"](around:${radius},${lat},${lon});
                  node["natural"="water"](around:${radius},${lat},${lon});
                  way["natural"="water"](around:${radius},${lat},${lon});
                );
                out center;`;

            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erreur API Overpass: ${response.statusText}`);
            const data = await response.json();
            
            return data.elements.map(el => {
                const tags = el.tags;
                let classificationKey = Object.keys(tags).map(k => tags[k]).find(val => placeClassification[val] || classificationAliases[val]);

                if (tags.amenity === 'butcher' && tags['diet:halal'] === 'yes') {
                    classificationKey = 'halal_butcher';
                }

                if (!classificationKey) return null;

                const finalKey = classificationAliases[classificationKey] || classificationKey;
                const classification = placeClassification[finalKey];
                if (!classification) return null;

                const placeLat = el.center ? el.center.lat : el.lat;
                const placeLon = el.center ? el.center.lon : el.lon;

                return {
                    name: tags.name,
                    ...classification,
                    lat: placeLat,
                    lon: placeLon
                };
            }).filter(p => p && p.lat && p.lon);
        }

        function displayResults(places) {
            resultsDiv.innerHTML = '';
            resultsHeader.classList.remove('hidden');

            const counts = { positive: 0, negative: 0, neutral: 0 };
            places.forEach(p => counts[p.type]++);
            
            let summaryText = `<h3 class="text-xl font-bold mb-2">R√©sum√© Spirituel de Votre Environnement</h3>`;
            if (places.length > 0) {
                 summaryText += `<p class="text-gray-300">Sur ${places.length} lieux identifi√©s, il y a <span class="text-green-400 font-semibold">${counts.positive} influences positives</span>, <span class="text-red-400 font-semibold">${counts.negative} influences n√©gatives</span> et <span class="text-gray-400 font-semibold">${counts.neutral} lieux neutres</span>.</p>`;
                if (counts.positive > counts.negative) {
                    summaryText += `<p class="mt-2 text-lg text-green-300">Alhamdulillah, votre environnement semble propice au rappel d'Allah.</p>`;
                } else {
                     summaryText += `<p class="mt-2 text-lg text-yellow-400">Soyez vigilant. Votre environnement pr√©sente des distractions.</p>`;
                }
            } else {
                 summaryText += `<p class="mt-2 text-lg text-gray-300">Aucun lieu notable n'a √©t√© identifi√©.</p>`;
            }
            summaryCard.innerHTML = summaryText;

            const glowClasses = { positive: 'border-green-500 card-glow-positive', negative: 'border-red-500 card-glow-negative', neutral: 'border-gray-500 card-glow-neutral' };
            places.slice(0, 21).forEach(place => {
                const distance = place.distance < 1 ? `${Math.round(place.distance * 1000)} m` : `${place.distance.toFixed(1)} km`;
                const mapLink = `https://www.openstreetmap.org/?mlat=${place.lat}&mlon=${place.lon}#map=17/${place.lat}/${place.lon}`;
                const card = `
                    <div class="result-card bg-gray-800 border ${glowClasses[place.type]} rounded-lg p-5 flex flex-col transform hover:-translate-y-1 h-full transition-colors duration-300" data-type="${place.type}">
                        <div class="flex-grow">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-start mr-2">
                                    <span class="text-3xl mr-3">${place.icon}</span>
                                    <div>
                                        <h3 class="text-lg font-bold text-white">${place.name || place.title}</h3>
                                        <p class="text-sm text-gray-400">${place.label}</p>
                                    </div>
                                </div>
                                <div class="flex-shrink-0 flex gap-2">
                                     <button class="share-btn text-gray-400 hover:text-white" title="Partager une r√©flexion">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                                    </button>
                                    <a href="${mapLink}" target="_blank" rel="noopener noreferrer" title="Voir sur la carte" class="text-gray-400 hover:text-white">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                    </a>
                                </div>
                            </div>
                            <p class="text-gray-400 mb-4">Situ√© √† ~<strong class="text-emerald-400">${distance}</strong> de votre position.</p>
                            <div class="border-t border-gray-700 pt-3">
                                <h4 class="font-semibold text-gray-200 mb-1">Interpr√©tation Spirituelle</h4>
                                <p class="text-gray-300 text-sm">${place.interpretation}</p>
                            </div>
                        </div>
                    </div>`;
                resultsDiv.innerHTML += card;
            });
            setupCardInteractions();
        }

        function setupCardInteractions() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const filter = e.target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-emerald-600'));
                e.target.classList.add('bg-emerald-600');
                document.querySelectorAll('.result-card').forEach(card => {
                    card.style.display = (filter === 'all' || card.dataset.type === filter) ? 'flex' : 'none';
                });
            }));
            
            document.querySelectorAll('.share-btn').forEach(btn => btn.addEventListener('click', e => {
                const card = e.target.closest('.result-card');
                const title = card.querySelector('h3').textContent;
                const interpretation = card.querySelector('p:last-child').textContent;
                const shareText = `R√©flexion du jour: La proximit√© de "${title}" est un rappel sur l'importance de "${interpretation.substring(0, 50)}...". Qu'Allah nous guide. #Tafakkur`;
                navigator.clipboard.writeText(shareText).then(() => {
                    statusDiv.textContent = 'R√©flexion copi√©e dans le presse-papiers!';
                    setTimeout(() => { if(statusDiv.textContent === 'R√©flexion copi√©e dans le presse-papiers!') statusDiv.textContent = 'Analyse termin√©e.'; }, 2000);
                });
            }));
        }
        
        // --- FONCTIONS DU TABLEAU DE BORD ---
        async function updateDashboard(lat, lon) {
            // CORRECTION: Appel √† l'API des horaires de pri√®re plus fiable
            try {
                const today = new Date();
                const dateString = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
                const response = await fetch(`https://api.aladhan.com/v1/timings/${dateString}?latitude=${lat}&longitude=${lon}&method=4`);
                if (!response.ok) throw new Error('Prayer times API failed');
                const data = await response.json();
                const timings = data.data.timings;
                
                // AM√âLIORATION: Met en √©vidence la prochaine pri√®re
                const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                let nextPrayerName = '';
                
                for (const prayer of prayerOrder) {
                    if (timings[prayer] > currentTime) {
                        nextPrayerName = prayer;
                        break;
                    }
                }
                if (!nextPrayerName) nextPrayerName = 'Fajr'; // Prochaine pri√®re est Fajr du lendemain

                prayerTimesDiv.innerHTML = prayerOrder.map(prayer => {
                    const isNext = prayer === nextPrayerName;
                    return `<p class="${isNext ? 'text-emerald-400 font-bold scale-110' : ''} transition-transform">${isNext ? '-> ' : ''}<strong>${prayer}:</strong> ${timings[prayer]}</p>`;
                }).join('');

            } catch (err) {
                prayerTimesDiv.textContent = 'Impossible de charger les horaires.';
                console.error(err);
            }
            
            const qiblaDirection = calculateQibla(lat, lon);
            qiblaArrow.style.transform = `rotate(${qiblaDirection}deg)`;
        }
        
        function updateVerseOfTheDay() {
            const verses = [
                { text: "En v√©rit√©, dans la cr√©ation des cieux et de la terre... il y a certes des signes pour les dou√©s d'intelligence.", ref: "Coran 3:190" },
                { text: "Et c'est Lui qui vous a assign√© les √©toiles, pour que, par elles, vous vous guidiez dans les t√©n√®bres...", ref: "Coran 6:97" },
                { text: "Ne parcourent-ils pas la terre pour voir ce qu'il est advenu de ceux qui ont v√©cu avant eux ?", ref: "Coran 12:109" },
                { text: "Le rappel de la mort est une mis√©ricorde.", ref: "Hadith" },
                { text: "Une heure de m√©ditation vaut mieux que soixante ans d'adoration.", ref: "Parole attribu√©e √† Ibn Abbas" }
            ];
            const verse = verses[Math.floor(Math.random() * verses.length)];
            verseOfTheDayDiv.innerHTML = `"${verse.text}" <br><span class="text-xs text-gray-500">- ${verse.ref}</span>`;
        }

        // --- FONCTIONS UTILITAIRES ---
        function handleOrientation(event) {
            const heading = event.webkitCompassHeading || event.alpha;
            if (heading !== null) {
                qiblaCompassContainer.style.transform = `rotate(${-heading}deg)`;
            }
        }
        
        function handleError(error) {
            const messages = {
                [error.PERMISSION_DENIED]: "Vous avez refus√© la demande de g√©olocalisation.",
                [error.POSITION_UNAVAILABLE]: "L'information de localisation est indisponible.",
                [error.TIMEOUT]: "La demande de localisation a expir√©.",
            };
            statusDiv.textContent = messages[error.code] || "Une erreur inconnue est survenue.";
            analyzeBtn.disabled = false;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        function calculateQibla(lat, lon) {
            const PI = Math.PI;
            const latK = 21.4225 * PI / 180.0;
            const lonK = 39.8264 * PI / 180.0;
            const lat_ = lat * PI / 180.0;
            const lon_ = lon * PI / 180.0;
            const dLon = lonK - lon_;
            const qibla = Math.atan2(Math.sin(dLon), (Math.cos(lat_) * Math.tan(latK)) - (Math.sin(lat_) * Math.cos(dLon)));
            return qibla * 180.0 / PI;
        }

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            initTheme();
        }

    </script>
</body>
</html>

